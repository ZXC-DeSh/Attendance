{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="text-center mb-4">
        <h1 class="display-4 text-primary">
            <i class="fas fa-book me-3"></i>Курсы
        </h1>
        <p class="lead text-muted">Просмотр и управление курсами</p>
    </div>

    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body py-3">
            <div class="row g-3 align-items-end">
                <div class="col-md-6">
                    <label for="liveSearch" class="form-label fw-semibold text-muted mb-2 fs-6">
                        <i class="fas fa-search me-2"></i>Поиск курсов
                    </label>
                    <div class="search-container position-relative">
                        <input type="text" class="form-control" id="liveSearch" placeholder="Введите название курса..." autocomplete="off">
                    </div>
                </div>
                
                <div class="col-md-3"></div>
                
                <div class="col-md-3">
                    <div class="row g-0">
                        <div class="col-6">
                            <label for="sort_by" class="form-label fw-semibold text-muted mb-2">
                                <i class="fas fa-sort me-2"></i>Сортировка
                            </label>
                            <select class="form-select form-select-sm h-100" name="sort_by" id="sort_by" style="max-width: 150px;">
                                <option value="favorites_first" {% if sort_by == 'favorites_first' %}selected{% endif %}>
                                    По умолчанию
                                </option>
                                <option value="name" {% if sort_by == 'name' %}selected{% endif %}>
                                    По названию (А-Я)
                                </option>
                                <option value="name_desc" {% if sort_by == 'name_desc' %}selected{% endif %}>
                                    По названию (Я-А)
                                </option>
                            </select>
                        </div>
                        
                        <div class="col-6">
                            <label for="filter_favorites" class="form-label fw-semibold text-muted mb-2">
                                <i class="fas fa-filter me-2"></i>Фильтр
                            </label>
                            <select class="form-select form-select-sm h-100" name="filter_favorites" id="filter_favorites" style="max-width: 150px;">
                                <option value="all" {% if filter_favorites == 'all' %}selected{% endif %}>
                                    Все курсы
                                </option>
                                <option value="favorites" {% if filter_favorites == 'favorites' %}selected{% endif %}>
                                    Только избранные
                                </option>
                                <option value="not_favorites" {% if filter_favorites == 'not_favorites' %}selected{% endif %}>
                                    Не избранные
                                </option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="coursesContainer" style="position: relative; z-index: 1;">
        {% if courses %}
            <div class="row courses-container">
                {% for course in courses %}
                    <div class="col-md-6 col-lg-4 col-xl-3 mb-4" data-course-id="{{ course.id }}">
                        <div class="card h-100 border-0 shadow-sm course-card position-relative">
                            <button onclick="toggleFavorite({{ course.id }}, this)" class="btn btn-sm btn-outline-secondary border-0 favorite-btn" data-course-id="{{ course.id }}" data-is-favorite="{% if course in current_user.favorite_courses %}true{% else %}false{% endif %}" title="{% if course in current_user.favorite_courses %}Убрать из избранного{% else %}Добавить в избранное{% endif %}">
                                <i class="fas fa-thumbtack {% if course in current_user.favorite_courses %}text-warning{% else %}text-secondary{% endif %}"></i>
                            </button>
                            
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i class="fas fa-book fa-3x text-primary"></i>
                                </div>
                                <h5 class="card-title text-primary">{{ course.name }}</h5>
                                {% if course.description %}
                                    <p class="card-text text-muted course-description">{{ course.description }}</p>
                                {% endif %}
                                
                                <div class="course-stats">
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <small class="text-muted">Преподаватели</small>
                                            <div class="fw-bold text-primary">{{ course.teachers|length }}</div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Студенты</small>
                                            <div class="fw-bold text-success">{{ course.students|length }}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-grid gap-2">
                                    {% if current_user.role == 'teacher' %}
                                        <a href="{{ url_for('mark_attendance') }}?course_id={{ course.id }}" 
                                           class="btn btn-outline-primary btn-sm action-btn">
                                            <i class="fas fa-check me-1"></i>Отметить посещаемость
                                        </a>
                                    {% endif %}
                                    
                                    {% if current_user.role == 'admin' %}
                                        <a href="{{ url_for('edit_course', course_id=course.id) }}" 
                                           class="btn btn-outline-primary btn-sm action-btn">
                                            <i class="fas fa-edit me-1"></i>Редактировать
                                        </a>
                                        <a href="{{ url_for('delete_course', course_id=course.id) }}" 
                                           class="btn btn-outline-danger btn-sm action-btn"
                                           onclick="return confirm('Вы уверены, что хотите удалить этот курс?')">
                                            <i class="fas fa-trash me-1"></i>Удалить
                                        </a>
                                        <a href="{{ url_for('assign_to_course') }}?course_id={{ course.id }}" 
                                           class="btn btn-outline-success btn-sm action-btn">
                                            <i class="fas fa-user-plus me-1"></i>Назначить
                                        </a>
                                    {% endif %}
                                    
                                    {% if current_user.role == 'teacher' and not current_user.role == 'admin' %}
                                        <div class="action-btn-placeholder"></div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            
            {% if next_url or prev_url %}
                <div class="d-flex justify-content-between align-items-center mt-4">
                    {% if prev_url %}
                        <a href="{{ prev_url }}" class="btn btn-outline-primary">
                            <i class="fas fa-chevron-left me-1"></i>Предыдущие курсы
                        </a>
                    {% endif %}
                    {% if next_url %}
                        <a href="{{ next_url }}" class="btn btn-outline-primary">
                            Следующие курсы<i class="fas fa-chevron-right ms-1"></i>
                        </a>
                    {% endif %}
                </div>
            {% endif %}
        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-book fa-3x text-muted mb-3"></i>
                <p class="text-muted">Курсы не найдены.</p>
                {% if search or filter_favorites != 'all' %}
                    <p class="text-muted">Попробуйте изменить параметры поиска или фильтры.</p>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>

<style>
:root {
    --bs-primary: #0d6efd;
    --bs-primary-dark: #0b5ed7;
    --bs-success: #198754;
    --bs-success-dark: #157347;
}

.course-card {
    position: relative !important;
    height: 100%;
    z-index: 1 !important;
    transition: all 0.3s ease-in-out;
}

.course-card.hidden {
    opacity: 0;
    transform: scale(0.8);
    height: 0;
    margin: 0;
    padding: 0;
    overflow: hidden;
    pointer-events: none;
}

.course-card.visible {
    opacity: 1;
    transform: scale(1);
    height: auto;
    margin-bottom: 1.5rem;
    pointer-events: auto;
}

.course-card {
    transition: all 0.3s ease-in-out;
}

.course-card.hidden {
    display: none !important;
}

.course-card.visible {
    display: block !important;
}

.row {
    display: flex;
    flex-wrap: wrap;
}

.courses-container, #coursesContainer {
    z-index: 1 !important;
    position: relative !important;
}

.course-card {
    position: relative;
    height: 100%;
    z-index: 1;
}

.search-container {
    position: relative;
    z-index: 1000;
}

.search-container .form-control {
    border: 1px solid #dee2e6;
    padding: 0.5rem 0.75rem;
    font-size: 0.9rem;
    background: #fff;
    box-shadow: none;
    border-radius: 0.5rem;
    height: 38px;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.search-container .form-control:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
    outline: none;
}

.form-select-sm.h-100 {
    height: 38px !important;
    padding: 0.5rem 0.75rem;
    font-size: 0.9rem;
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.form-select-sm.h-100:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
    outline: none;
}

.col-md-4 .col-6 {
    margin-bottom: 0;
}

.card.border-0.shadow-sm.mb-4 {
    transition: none !important;
}

.card.border-0.shadow-sm.mb-4:hover {
    transform: none !important;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075) !important;
}

.favorite-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 10;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(5px);
}

.favorite-btn:hover {
    transform: scale(1.1);
    background: rgba(255, 255, 255, 1);
}

.favorite-btn.favorite {
    background: #ffc107;
    border-color: #ffc107;
}

.favorite-btn.favorite .fas {
    color: #fff !important;
}

.favorite-btn:not(.favorite) .fas {
    color: #6c757d !important;
}

.favorite-btn[data-is-favorite="true"] {
    background: #ffc107;
    border-color: #ffc107;
}

.favorite-btn[data-is-favorite="true"] .fas {
    color: #fff !important;
}

.favorite-btn[data-is-favorite="false"] .fas {
    color: #6c757d !important;
}

.action-btn {
    height: 38px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.875rem;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    padding: 0.375rem 0.75rem;
}

.action-btn i {
    flex-shrink: 0;
    margin-right: 0.25rem;
}

.action-btn-placeholder {
    height: 38px;
    background: transparent;
}

.course-card .btn-outline-primary {
    background-color: transparent;
    border-color: #0d6efd;
    color: #0d6efd;
}

.course-card .btn-outline-primary:hover {
    background-color: #0d6efd;
    color: white !important;
    border-color: #0d6efd;
}

.course-card .btn-outline-success {
    color: #198754;
    border-color: #198754;
    background-color: transparent;
}

.course-card .btn-outline-success:hover {
    background-color: #198754;
    color: white !important;
    border-color: #198754;
}

.course-card .btn-outline-danger {
    color: #dc3545 !important;
    border-color: #dc3545 !important;
    background-color: transparent !important;
}

.course-card .btn-outline-danger:hover {
    background-color: #dc3545 !important;
    color: white !important;
    border-color: #dc3545 !important;
}

.course-card .card-body {
    display: flex;
    flex-direction: column;
    height: 100%;
}

.course-card .card-body .d-grid {
    margin-top: auto;
}

.course-stats {
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    margin-top: auto;
    margin-bottom: 1rem;
}

.course-stats .row {
    width: 100%;
    margin: 0;
    height: 100%;
    align-items: center;
}

.course-stats .col-6 {
    padding: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
}

.course-stats small {
    display: block;
    margin-bottom: 0.25rem;
    font-size: 0.75rem;
    line-height: 1;
    height: 1rem;
}

.course-stats .fw-bold {
    font-size: 1.25rem;
    line-height: 1;
    height: 1.5rem;
    display: flex;
    align-items: center;
}

.course-card .card-body .d-grid {
    margin-top: 0;
    padding-top: 0;
}

.course-description {
    margin-bottom: 1rem;
    min-height: 3rem;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.5;
}

#pageLoadingOverlay {
    backdrop-filter: blur(2px);
}

@media (max-width: 768px) {
    .col-md-3.d-flex {
        flex-direction: column;
        width: 100%;
    }
    
    .col-md-3.d-flex .btn {
        width: 100%;
        margin-bottom: 0.5rem;
    }
    
    .search-container {
        margin-bottom: 1rem;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    try {
        const coursesContainer = document.getElementById('coursesContainer');
        if (coursesContainer) {
            window.originalCoursesHTML = coursesContainer.innerHTML;
        }
        
        const hasFavorites = initializeFavoriteButtons();
        
        const sortSelect = document.getElementById('sort_by');
        if ((sortSelect && sortSelect.value === 'favorites_first') || hasFavorites) {
            setTimeout(() => {
                resortCourses();
            }, 100);
        }
        
        setupLiveSearch();
        setupFilterHandlers();
        
    } catch (error) {
        console.error('Ошибка инициализации:', error);
    }
});

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 3000);
}

function setupLiveSearch() {
    const searchInput = document.getElementById('liveSearch');
    if (!searchInput) return;

    let searchTimeout;
    let currentSearchTerm = '';

    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.trim();
        
        clearTimeout(searchTimeout);
        
        if (!searchTerm) {
            restoreAllCourses();
            currentSearchTerm = '';
            
            const sortSelect = document.getElementById('sort_by');
            const filterSelect = document.getElementById('filter_favorites');
            
            if (sortSelect) {
                applySorting(sortSelect.value);
            }
            if (filterSelect) {
                applyFilter(filterSelect.value);
            }
            return;
        }

        currentSearchTerm = searchTerm;

        searchTimeout = setTimeout(() => {
            performLiveSearch(searchTerm);
        }, 300);
    });

    const sortSelect = document.getElementById('sort_by');
    if (sortSelect) {
        sortSelect.addEventListener('change', function() {
            const selectedValue = this.value;
            showPageLoading();
            applySorting(selectedValue);
        });
    }

    const filterSelect = document.getElementById('filter_favorites');
    if (filterSelect) {
        filterSelect.addEventListener('change', function() {
            const selectedValue = this.value;
            showPageLoading();
            applyFilter(selectedValue);
        });
    }
}

function restoreAllCourses() {
    const coursesContainer = document.getElementById('coursesContainer');
    if (!coursesContainer) return;
    
    const coursesRow = coursesContainer.querySelector('.row.courses-container');
    if (!coursesRow) return;
    
    const courseColumns = Array.from(coursesRow.querySelectorAll('.col-md-6, .col-lg-4, .col-xl-3'));
    
    courseColumns.forEach(column => {
        const card = column.querySelector('.course-card');
        if (card) {
            card.classList.remove('hidden');
            card.classList.add('visible');
        }
        
        column.style.display = 'block';
    });
}

function applySorting(sortType) {
    const currentUrl = new URL(window.location);
    currentUrl.searchParams.set('sort_by', sortType);
    
    const searchInput = document.getElementById('liveSearch');
    if (searchInput && searchInput.value.trim()) {
        currentUrl.searchParams.set('search', searchInput.value.trim());
    }
    
    const filterSelect = document.getElementById('filter_favorites');
    if (filterSelect) {
        currentUrl.searchParams.set('filter_favorites', filterSelect.value);
    }
    
    window.location.href = currentUrl.toString();
}

function applyFilter(filterType) {
    const currentUrl = new URL(window.location);
    currentUrl.searchParams.set('filter_favorites', filterType);
    
    const searchInput = document.getElementById('liveSearch');
    if (searchInput && searchInput.value.trim()) {
        currentUrl.searchParams.set('search', searchInput.value.trim());
    }
    
    const sortSelect = document.getElementById('sort_by');
    if (sortSelect) {
        currentUrl.searchParams.set('sort_by', sortSelect.value);
    }
    
    window.location.href = currentUrl.toString();
}

function toggleFavorite(courseId, button) {
    fetch(`/toggle_favorite/${courseId}`)
        .then(response => {
            if (response.ok) {
                const isFavorite = button.getAttribute('data-is-favorite') === 'true';
                const newFavoriteStatus = !isFavorite;
                
                button.setAttribute('data-is-favorite', newFavoriteStatus.toString());
                
                if (newFavoriteStatus) {
                    button.classList.add('favorite');
                    button.title = 'Убрать из избранного';
                    button.querySelector('.fas').classList.remove('text-secondary');
                    button.querySelector('.fas').classList.add('text-warning');
                } else {
                    button.classList.remove('favorite');
                    button.title = 'Добавить в избранное';
                    button.querySelector('.fas').classList.remove('text-warning');
                    button.querySelector('.fas').classList.add('text-secondary');
                }
                
                const sortSelect = document.getElementById('sort_by');
                if (sortSelect && sortSelect.value === 'favorites_first') {
                    resortCourses();
                }
            } else {
                console.error('Ошибка при обновлении избранного');
            }
        })
        .catch(error => {
            console.error('Ошибка при обновлении избранного:', error);
        });
}

function resortCourses() {
    const coursesContainer = document.getElementById('coursesContainer');
    if (!coursesContainer) return;
    
    const coursesRow = coursesContainer.querySelector('.row.courses-container');
    if (!coursesRow) return;
    
    const courseColumns = Array.from(coursesRow.querySelectorAll('.col-md-6, .col-lg-4, .col-xl-3'));
    if (courseColumns.length === 0) return;
    
    courseColumns.sort((a, b) => {
        const buttonA = a.querySelector('.favorite-btn');
        const buttonB = b.querySelector('.favorite-btn');
        const isFavoriteA = buttonA && buttonA.getAttribute('data-is-favorite') === 'true';
        const isFavoriteB = buttonB && buttonB.getAttribute('data-is-favorite') === 'true';
        
        if (isFavoriteA && !isFavoriteB) return -1;
        if (!isFavoriteA && isFavoriteB) return 1;
        
        const nameA = a.querySelector('.card-title')?.textContent?.toLowerCase() || '';
        const nameB = b.querySelector('.card-title')?.textContent?.toLowerCase() || '';
        return nameA.localeCompare(nameB, 'ru');
    });
    
    courseColumns.forEach((column) => {
        coursesRow.appendChild(column);
    });
}

function initializeFavoriteButtons() {
    const favoriteButtons = document.querySelectorAll('.favorite-btn');
    let hasFavorites = false;
    
    favoriteButtons.forEach(button => {
        const isFavorite = button.getAttribute('data-is-favorite') === 'true';
        
        if (isFavorite) {
            button.classList.add('favorite');
            button.title = 'Убрать из избранного';
            hasFavorites = true;
        } else {
            button.classList.remove('favorite');
            button.title = 'Добавить в избранное';
        }
    });
    
    return hasFavorites;
}

function performLiveSearch(searchTerm) {
    const courseCards = document.querySelectorAll('.course-card');
    
    if (courseCards.length === 0) {
        const alternativeCards = document.querySelectorAll('[data-course-id]');
        if (alternativeCards.length > 0) {
            filterCoursesByAlternativeSelector(alternativeCards, searchTerm);
            return;
        }
    }
    
    let visibleCount = 0;
    
    courseCards.forEach((card) => {
        const courseName = card.querySelector('.card-title')?.textContent?.toLowerCase() || 
                          card.querySelector('h5')?.textContent?.toLowerCase() ||
                          card.querySelector('h6')?.textContent?.toLowerCase() || '';
        
        const courseDescription = card.querySelector('.course-description')?.textContent?.toLowerCase() ||
                                 card.querySelector('.card-text')?.textContent?.toLowerCase() || '';
        
        const searchLower = searchTerm.toLowerCase();
        const matches = courseName.includes(searchLower) || courseDescription.includes(searchLower);
        
        if (matches) {
            card.classList.remove('hidden');
            card.classList.add('visible');
            
            const column = card.closest('.col-md-6, .col-lg-4, .col-xl-3');
            if (column) {
                column.style.display = 'block';
            }
            
            visibleCount++;
        } else {
            card.classList.remove('visible');
            card.classList.add('hidden');
            
            const column = card.closest('.col-md-6, .col-lg-4, .col-xl-3');
            if (column) {
                column.style.display = 'none';
            }
        }
    });
    
    showNoResultsMessage(visibleCount === 0, searchTerm);
}

function filterCoursesByAlternativeSelector(cards, searchTerm) {
    let visibleCount = 0;
    const searchLower = searchTerm.toLowerCase();
    
    cards.forEach((card) => {
        const courseName = card.querySelector('.card-title')?.textContent?.toLowerCase() || 
                          card.querySelector('h5')?.textContent?.toLowerCase() ||
                          card.querySelector('h6')?.textContent?.toLowerCase() || '';
        
        const courseDescription = card.querySelector('.course-description')?.textContent?.toLowerCase() ||
                                 card.querySelector('.card-text')?.textContent?.toLowerCase() || '';
        
        const matches = courseName.includes(searchLower) || courseDescription.includes(searchLower);
        
        if (matches) {
            card.classList.remove('hidden');
            card.classList.add('visible');
            
            const column = card.closest('.col-md-6, .col-lg-4, .col-xl-3');
            if (column) {
                column.style.display = 'block';
            }
            
            visibleCount++;
        } else {
            card.classList.remove('visible');
            card.classList.add('hidden');
            
            const column = card.closest('.col-md-6, .col-lg-4, .col-xl-3');
            if (column) {
                column.style.display = 'none';
            }
        }
    });
    
    showNoResultsMessage(visibleCount === 0, searchTerm);
}

function showNoResultsMessage(noResults, searchTerm) {
    const coursesContainer = document.getElementById('coursesContainer');
    
    if (noResults) {
        const noResultsHTML = `
            <div class="text-center py-5">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <p class="text-muted">По запросу "${searchTerm}" ничего не найдено</p>
                <small>Попробуйте изменить поисковый запрос</small>
            </div>
        `;
        
        coursesContainer.innerHTML = noResultsHTML;
    }
}

function setupFilterHandlers() {
    console.log('Фильтры настроены для автоматической работы');
}

function showPageLoading() {
    const container = document.querySelector('.container');
    if (container) {
        const loadingOverlay = document.createElement('div');
        loadingOverlay.id = 'pageLoadingOverlay';
        loadingOverlay.className = 'position-fixed w-100 h-100 d-flex align-items-center justify-content-center';
        loadingOverlay.style.cssText = 'top: 0; left: 0; background: rgba(255, 255, 255, 0.8); z-index: 9999;';
        loadingOverlay.innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary mb-2" role="status">
                    <span class="visually-hidden">Загрузка...</span>
                </div>
                <p class="text-primary mb-0">Применение фильтров...</p>
            </div>
        `;
        document.body.appendChild(loadingOverlay);
    }
}

function hidePageLoading() {
    const loadingOverlay = document.getElementById('pageLoadingOverlay');
    if (loadingOverlay) {
        loadingOverlay.remove();
    }
}
</script>

{% endblock %}
