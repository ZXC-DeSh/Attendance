{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-5 text-primary">
                        <i class="fas fa-users me-3"></i>Группа {{ group.name }}
                    </h1>
                    <p class="lead text-muted">{{ group.specialty }} • {{ group.course_year }} курс • Группа {{ group.group_number }}</p>
                </div>
                <div>
                    <a href="{{ url_for('group') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Назад к группам
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white p-0">
                    <div class="p-3">
                        <h5 class="mb-0">
                            <i class="fas fa-table me-2"></i>Посещаемость группы
                            <span class="badge bg-light text-primary ms-2">{{ selected_date }}</span>
                        </h5>
                    </div>
                    {% if students %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr class="table-header-unified">
                                        <th class="border-0">№</th>
                                        <th class="border-0">Студент</th>
                                        <th class="border-0">Статус</th>
                                        <th class="border-0">Курс</th>
                                        <th class="border-0">Примечания</th>
                                        {% if current_user.role == 'teacher' %}
                                            <th class="border-0">Действия</th>
                                        {% endif %}
                                    </tr>
                                </thead>
                            </table>
                        </div>
                    {% endif %}
                </div>
                
                {% if students %}
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <tbody>
                                    {% for student in students %}
                                        {% set stats = attendance_stats.get(student.id, {}) %}
                                        <tr>
                                            <td class="text-muted">{{ loop.index }}</td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <img src="{{ student.avatar(32) }}" alt="Аватар" 
                                                         class="rounded-circle me-2" style="width: 32px; height: 32px;">
                                                    <div>
                                                        <strong>{{ student.username }}</strong>
                                                        <br>
                                                        <small class="text-muted">{{ student.email }}</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                {% if stats.status == 'present' %}
                                                    <span class="badge bg-success">
                                                        <i class="fas fa-check me-1"></i>Присутствует
                                                    </span>
                                                {% elif stats.status == 'absent' %}
                                                    <span class="badge bg-danger">
                                                        <i class="fas fa-times me-1"></i>Отсутствует
                                                    </span>
                                                {% elif stats.status == 'late' %}
                                                    <span class="badge bg-warning">
                                                        <i class="fas fa-clock me-1"></i>Опоздал
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-secondary">
                                                        <i class="fas fa-question me-1"></i>Не отмечено
                                                    </span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <small class="text-muted">{{ stats.course_name }}</small>
                                            </td>
                                            <td>
                                                {% if stats.notes %}
                                                    <small class="text-muted">{{ stats.notes }}</small>
                                                {% else %}
                                                    <small class="text-muted">-</small>
                                                {% endif %}
                                            </td>
                                            {% if current_user.role == 'teacher' %}
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <button class="btn btn-outline-success" title="Присутствует">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                        <button class="btn btn-outline-danger" title="Отсутствует">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                        <button class="btn btn-outline-warning" title="Опоздал">
                                                            <i class="fas fa-clock"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            {% endif %}
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                {% else %}
                    <div class="card-body text-center py-5">
                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Студенты не найдены</h5>
                        <p class="text-muted">В этой группе пока нет студентов</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="col-lg-4">
            <div class="mini-calendar">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-calendar me-2"></i>Календарь
                        </h6>
                    </div>
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <button class="btn btn-sm btn-outline-primary" onclick="changeMonth(-1)">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <h6 class="mb-0">{{ current_month.strftime('%B %Y') }}</h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="changeMonth(1)">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        
                        <div class="calendar-grid">
                            <div class="calendar-header">
                                <div class="calendar-cell">Пн</div>
                                <div class="calendar-cell">Вт</div>
                                <div class="calendar-cell">Ср</div>
                                <div class="calendar-cell">Чт</div>
                                <div class="calendar-cell">Пт</div>
                                <div class="calendar-cell">Сб</div>
                                <div class="calendar-cell">Вс</div>
                            </div>
                            
                            {% set days_in_month = (current_month.replace(month=current_month.month + 1) - timedelta(days=1)).day %}
                            {% set first_day_of_week = (current_month.replace(day=1)).weekday() %}
                            {% set first_day_of_week = (first_day_of_week + 1) % 7 %}
                            
                            <div class="calendar-body">
                                {% for i in range(first_day_of_week) %}
                                    <div class="calendar-cell empty"></div>
                                {% endfor %}
                                
                                {% for day in range(1, days_in_month + 1) %}
                                    {% set current_date = current_month.replace(day=day) %}
                                    {% set is_selected = current_date.strftime('%Y-%m-%d') == selected_date %}
                                    {% set is_today = current_date.date() == today %}
                                    {% set is_weekend = current_date.weekday() >= 5 %}
                                    
                                    <div class="calendar-cell {% if is_selected %}selected{% endif %} {% if is_today %}today{% endif %} {% if is_weekend %}weekend{% endif %}"
                                         onclick="selectDate('{{ current_date.strftime('%Y-%m-%d') }}')"
                                         title="{{ current_date.strftime('%d.%m.%Y') }}">
                                        {{ day }}
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="group-stats mt-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>Статистика группы
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="stats-item">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Всего студентов:</span>
                                <strong>{{ group.current_students_count }}/{{ group.max_students }}</strong>
                            </div>
                            <div class="progress">
                                <div class="progress-bar bg-primary" 
                                     style="width: {{ (group.current_students_count / group.max_students * 100)|round(1) }}%">
                                </div>
                            </div>
                        </div>
                        
                        <div class="stats-item">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Присутствует сегодня:</span>
                                <strong class="text-success">{{ present_count }}</strong>
                            </div>
                        </div>
                        
                        <div class="stats-item">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Отсутствует сегодня:</span>
                                <strong class="text-danger">{{ absent_count }}</strong>
                            </div>
                        </div>
                        
                        <div class="stats-item">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Опоздал сегодня:</span>
                                <strong class="text-warning">{{ late_count }}</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.calendar-grid {
    border: none;
}

.calendar-header {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
    margin-bottom: 8px;
}

.calendar-body {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
}

.calendar-cell {
    padding: 8px 4px;
    text-align: center;
    cursor: pointer;
    border-radius: 4px;
    font-size: 0.9rem;
    min-height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.calendar-cell:hover {
    background-color: #e9ecef;
}

.calendar-cell.selected {
    background-color: #0d6efd;
    color: white;
}

.calendar-cell.today {
    background-color: #198754;
    color: white;
}

.calendar-cell.weekend {
    color: #6c757d;
}

.calendar-cell.empty {
    background-color: transparent;
    cursor: default;
}

.stats-item {
    padding: 0.5rem 0;
}

.stats-item .progress {
    background-color: #e9ecef;
}

.table-header-unified th {
    border: none !important;
    color: white !important;
    font-weight: 600;
    height: auto;
    line-height: 1.2;
}

.card-header .table {
    margin-bottom: 0;
}

.card-header .table thead th {
    padding: 0.5rem 0.75rem;
    text-align: center;
    vertical-align: middle;
    white-space: nowrap;
}

.card-body .table tbody tr:last-child td {
    border-bottom: none;
}

.card-body .table tbody td {
    padding: 0.75rem;
    vertical-align: middle;
    border: none;
}

.card-body .table tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.02);
}

.card-body .table tbody td {
    border: none !important;
}

@media (max-width: 992px) {
    .mini-calendar {
        margin-bottom: 1rem;
    }
    
    .calendar-cell {
        padding: 6px 2px;
        font-size: 0.8rem;
        min-height: 28px;
    }
}
</style>

<script>
function selectDate(dateString) {
    const currentUrl = new URL(window.location);
    currentUrl.searchParams.set('date', dateString);
    window.location.href = currentUrl.toString();
}

function changeMonth(delta) {
    const urlParams = new URLSearchParams(window.location.search);
    let currentDate = urlParams.get('date');
    
    if (!currentDate) {
        currentDate = new Date().toISOString().split('T')[0];
    }
    
    const date = new Date(currentDate);
    date.setMonth(date.getMonth() + delta);
    
    const newDate = date.toISOString().split('T')[0];
    selectDate(newDate);
}
</script>

{% endblock %}
